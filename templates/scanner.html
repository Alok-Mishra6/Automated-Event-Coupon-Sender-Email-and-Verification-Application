<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Ticket Scanner - QR Verification</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --border: #374151;
            --shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }
        
        /* Animated background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.2) 0%, transparent 50%);
            z-index: -1;
            animation: backgroundShift 20s ease-in-out infinite;
        }
        
        @keyframes backgroundShift {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.1) rotate(1deg); }
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--bg-secondary);
            border-radius: 24px;
            box-shadow: var(--shadow);
            overflow: hidden;
            border: 1px solid var(--border);
            backdrop-filter: blur(20px);
            animation: slideUp 0.8s ease-out;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .header {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            color: var(--text-primary);
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 12px;
            background: linear-gradient(135deg, #ffffff 0%, #e0e7ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
            z-index: 1;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 400;
            position: relative;
            z-index: 1;
            margin-bottom: 16px;
        }
        
        .main-content {
            padding: 40px;
        }
        
        .nav-links {
            display: flex;
            justify-content: center;
            gap: 32px;
            margin-bottom: 40px;
        }
        
        .nav-links a {
            color: var(--text-secondary);
            padding: 12px 24px;
            border-radius: 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            text-decoration: none;
            font-weight: 500;
        }
        
        .nav-links a:hover {
            color: var(--text-primary);
            border-color: var(--accent-primary);
            transform: translateY(-1px);
        }
        
        .nav-links a[href="/scanner"] {
            color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.1);
            border-color: rgba(99, 102, 241, 0.3);
        }
        
        .scanner-section {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .camera-container {
            position: relative;
            max-width: 400px;
            margin: 0 auto 20px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        #video {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 3px solid #fff;
            border-radius: 15px;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.3);
        }
        
        .scanner-corners {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 220px;
            height: 220px;
        }
        
        .corner {
            position: absolute;
            width: 30px;
            height: 30px;
            border: 4px solid #00ff00;
        }
        
        .corner.top-left {
            top: 0;
            left: 0;
            border-right: none;
            border-bottom: none;
        }
        
        .corner.top-right {
            top: 0;
            right: 0;
            border-left: none;
            border-bottom: none;
        }
        
        .corner.bottom-left {
            bottom: 0;
            left: 0;
            border-right: none;
            border-top: none;
        }
        
        .corner.bottom-right {
            bottom: 0;
            right: 0;
            border-left: none;
            border-top: none;
        }
        
        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-family: inherit;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            color: var(--text-primary);
            border: 1px solid transparent;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
            border-color: rgba(255,255,255,0.2);
        }
        
        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
            border-color: var(--accent-primary);
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            background: var(--bg-tertiary) !important;
            color: var(--text-muted) !important;
        }
        
        .result-section {
            margin-top: 32px;
            padding: 24px;
            border-radius: 16px;
            display: none;
            border: 1px solid;
            backdrop-filter: blur(10px);
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .result-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border-color: rgba(16, 185, 129, 0.3);
        }
        
        .result-error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
            border-color: rgba(239, 68, 68, 0.3);
        }
        
        .result-info {
            background: rgba(99, 102, 241, 0.1);
            color: var(--accent-primary);
            border-color: rgba(99, 102, 241, 0.3);
        }
        
        .coupon-details {
            margin-top: 15px;
            text-align: left;
        }
        
        .coupon-details h3 {
            margin-bottom: 10px;
        }
        
        .detail-item {
            margin: 8px 0;
            padding: 8px;
            background: rgba(255,255,255,0.3);
            border-radius: 5px;
        }
        
        .manual-entry {
            margin-top: 40px;
            padding: 32px;
            background: var(--bg-tertiary);
            border-radius: 16px;
            border: 1px solid var(--border);
            backdrop-filter: blur(10px);
        }
        
        .manual-entry h3 {
            color: var(--text-primary);
            margin-bottom: 16px;
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .manual-entry p {
            color: var(--text-secondary);
            margin-bottom: 24px;
            line-height: 1.6;
        }
        
        .form-group {
            margin-bottom: 24px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.95rem;
        }
        
        .form-group input {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s ease;
            font-family: inherit;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            transform: translateY(-1px);
        }
        
        .form-group input::placeholder {
            color: var(--text-muted);
        }
        
        .form-group small {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-top: 8px;
            display: block;
            line-height: 1.4;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-scanning {
            background: #ffc107;
            animation: pulse 1.5s infinite;
        }
        
        .status-success {
            background: #28a745;
        }
        
        .status-error {
            background: #dc3545;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% {
                animation-timing-function: cubic-bezier(0.215, 0.610, 0.355, 1.000);
                transform: translate3d(0,0,0);
            }
            40%, 43% {
                animation-timing-function: cubic-bezier(0.755, 0.050, 0.855, 0.060);
                transform: translate3d(0, -30px, 0);
            }
            70% {
                animation-timing-function: cubic-bezier(0.755, 0.050, 0.855, 0.060);
                transform: translate3d(0, -15px, 0);
            }
            90% {
                transform: translate3d(0,-4px,0);
            }
        }
        
        @keyframes shake {
            0%, 100% {
                transform: translate3d(0, 0, 0);
            }
            10%, 30%, 50%, 70%, 90% {
                transform: translate3d(-10px, 0, 0);
            }
            20%, 40%, 60%, 80% {
                transform: translate3d(10px, 0, 0);
            }
        }
        
        .hidden {
            display: none !important;
        }
        
        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .camera-container {
                max-width: 300px;
            }
            
            .scanner-overlay {
                width: 150px;
                height: 150px;
            }
            
            .scanner-corners {
                width: 170px;
                height: 170px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé´ Event Ticket Scanner</h1>
            <p>Scan event tickets to verify and admit attendees</p>
            <div style="background: rgba(255,255,255,0.15); padding: 16px; border-radius: 12px; margin-top: 20px; font-size: 14px; border: 1px solid rgba(255,255,255,0.2); position: relative; z-index: 1;">
                ‚ö° <strong>Lightning Fast:</strong> New tickets include attendee info automatically - instant verification!
            </div>
        </div>
        
        <div class="main-content">
            <div class="nav-links">
                <a href="/">üè† Dashboard</a>
                <a href="/sender">üé´ Event Manager</a>
                <a href="/scanner">üì± Ticket Scanner</a>
            </div>
            
            <!-- Device Registration Modal -->
            <div id="deviceRegistrationModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; backdrop-filter: blur(10px);">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-secondary); padding: 40px; border-radius: 16px; border: 1px solid var(--border); max-width: 500px; width: 90%;">
                    <h3 style="color: var(--accent-primary); margin-bottom: 20px; text-align: center;">üì± Device Registration</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 30px; text-align: center;">To use the scanner, please register this device with your staff information.</p>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; color: var(--text-primary); margin-bottom: 8px; font-weight: 500;">Staff Email Address</label>
                        <input type="email" id="staffEmail" placeholder="your.email@example.com" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-tertiary); color: var(--text-primary); font-size: 16px;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; color: var(--text-primary); margin-bottom: 8px; font-weight: 500;">Device Name</label>
                        <input type="text" id="deviceName" placeholder="Scanner-Mobile-1" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-tertiary); color: var(--text-primary); font-size: 16px;">
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <label style="display: block; color: var(--text-primary); margin-bottom: 8px; font-weight: 500;">Event Name</label>
                        <input type="text" id="eventName" placeholder="My Event 2025" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-tertiary); color: var(--text-primary); font-size: 16px;">
                    </div>
                    
                    <div style="text-align: center;">
                        <button class="btn btn-primary" onclick="registerDevice()" style="margin-right: 10px;">‚úÖ Register Device</button>
                        <button class="btn btn-secondary" onclick="skipRegistration()">‚è≠Ô∏è Skip (Limited Features)</button>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: rgba(99, 102, 241, 0.1); border-radius: 8px; border: 1px solid rgba(99, 102, 241, 0.3);">
                        <p style="color: var(--text-secondary); font-size: 14px; margin: 0;">
                            <strong>Note:</strong> Registration enables real-time synchronization with other staff devices. You can still scan tickets without registration, but won't see live updates from other scanners.
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Verification Result Modal -->
            <div id="verificationModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; backdrop-filter: blur(15px);">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-secondary); padding: 40px; border-radius: 20px; border: 2px solid var(--border); max-width: 600px; width: 90%; box-shadow: var(--shadow);">
                    <div id="verificationContent">
                        <!-- Content will be populated by JavaScript -->
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: center; margin-top: 30px;">
                        <button onclick="closeVerificationModal()" class="btn btn-primary" style="min-width: 120px;">‚úÖ Continue</button>
                        <button onclick="closeVerificationModal(); resumeScanning();" class="btn btn-secondary" style="min-width: 120px;">üîÑ Scan Next</button>
                    </div>
                </div>
            </div>
            
            <div class="scanner-section">
                <div class="camera-container" id="cameraContainer">
                    <video id="video" autoplay muted playsinline></video>
                    <div class="scanner-overlay"></div>
                    <div class="scanner-corners">
                        <div class="corner top-left"></div>
                        <div class="corner top-right"></div>
                        <div class="corner bottom-left"></div>
                        <div class="corner bottom-right"></div>
                    </div>
                </div>
                
                <div>
                    <span class="status-indicator" id="statusIndicator"></span>
                    <span id="statusText">Click "Start Scanner" to begin</span>
                </div>
                
                <div style="margin-top: 10px; padding: 12px; background: rgba(99, 102, 241, 0.1); border-radius: 8px; border: 1px solid rgba(99, 102, 241, 0.3); font-size: 14px;">
                    üí° <strong>Quick Actions:</strong>
                    <br>‚Ä¢ <span style="background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-family: monospace;">Spacebar</span> = Capture & Scan manually
                    <br>‚Ä¢ <span style="background: #f1f5f9; padding: 2px 6px; border-radius: 4px;">Long press video</span> = Capture on mobile  
                    <br>‚Ä¢ Use "üì∏ Capture & Scan" button if auto-detection isn't working
                </div>
                
                <div style="margin-top: 15px;">
                    <button class="btn btn-primary" id="startBtn" onclick="startScanner()">
                        üì∑ Start Scanner
                    </button>
                    <button class="btn btn-secondary" id="stopBtn" onclick="stopScanner()" disabled>
                        ‚èπÔ∏è Stop Scanner
                    </button>
                    <button class="btn btn-secondary" onclick="trySimpleCamera()" style="margin-left: 10px;">
                        üéØ Simple Camera Access
                    </button>
                    <button class="btn btn-primary" id="captureBtn" onclick="captureAndScan()" disabled style="margin-left: 10px;">
                        üì∏ Capture & Scan
                    </button>
                </div>
                
                <div style="margin-top: 15px;">
                    <button class="btn btn-secondary" onclick="showCameraHelp()" style="font-size: 14px; padding: 12px 20px; margin-right: 10px;">
                        üì± Camera Not Working? Get Help
                    </button>
                    <button class="btn btn-secondary" onclick="tryBackCamerasFirst()" style="font-size: 14px; padding: 12px 20px;">
                        üéØ Try Back Cameras First
                    </button>
                    <button class="btn btn-secondary" onclick="showDebugInfo()" style="font-size: 14px; padding: 12px 20px; margin-left: 5px;">
                        üîç Debug Info
                    </button>
                </div>
            </div>
            
            <div class="result-section" id="resultSection">
                <div id="resultContent"></div>
            </div>
            
            <div class="manual-entry">
                <h3>üîç Manual Verification</h3>
                <p>If the scanner isn't working, you can manually enter the coupon details:</p>
                
                <div class="form-group">
                    <label for="manualData">Coupon QR Code Data</label>
                    <input type="text" id="manualData" placeholder="Paste the complete QR code data here">
                    <small style="color: #666; font-size: 12px;">For new coupons, this contains all needed information. For old coupons, you'll need the email below.</small>
                </div>
                
                <div class="form-group">
                    <label for="manualEmail">Email Address (if needed)</label>
                    <input type="email" id="manualEmail" placeholder="Enter recipient email (only for old format coupons)">
                    <small style="color: #666; font-size: 12px;">Only required for older coupon formats. New coupons include the email automatically.</small>
                </div>
                
                <button class="btn btn-primary" onclick="verifyManual()">
                    ‚úÖ Verify Coupon
                </button>
            </div>
        </div>
    </div>
    
    <!-- Include jsQR library for QR code detection -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    
    <script>
        // Global variables
        let video = null;
        let canvas = null;
        let context = null;
        let scanning = false;
        let stream = null;
        let deviceRegistered = false;
        let deviceInfo = null;
        
        // Utility functions
        function updateStatus(text, type = 'scanning') {
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            statusIndicator.className = `status-indicator status-${type}`;
            statusText.textContent = text;
        }
        
        function showResult(content, type = 'info') {
            const resultSection = document.getElementById('resultSection');
            const resultContent = document.getElementById('resultContent');
            
            resultSection.className = `result-section result-${type}`;
            resultSection.style.display = 'block';
            resultContent.innerHTML = content;
            
            // Auto-hide after 10 seconds for success/error messages
            if (type !== 'info') {
                setTimeout(() => {
                    resultSection.style.display = 'none';
                }, 10000);
            }
        }
        
        // Debug information function
        async function showDebugInfo() {
            try {
                updateStatus('üîç Gathering debug information...', 'info');
                
                const debugInfo = {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    cookieEnabled: navigator.cookieEnabled,
                    onLine: navigator.onLine,
                    language: navigator.language,
                    hardwareConcurrency: navigator.hardwareConcurrency,
                    deviceMemory: navigator.deviceMemory || 'unknown',
                    connection: navigator.connection ? {
                        effectiveType: navigator.connection.effectiveType,
                        downlink: navigator.connection.downlink
                    } : 'unknown'
                };
                
                // Check media devices support
                const mediaDevicesSupport = {
                    supported: !!navigator.mediaDevices,
                    getUserMedia: !!navigator.mediaDevices?.getUserMedia,
                    enumerateDevices: !!navigator.mediaDevices?.enumerateDevices
                };
                
                // Get permissions info
                let permissionsInfo = 'unknown';
                if (navigator.permissions) {
                    try {
                        const permission = await navigator.permissions.query({ name: 'camera' });
                        permissionsInfo = permission.state;
                    } catch (e) {
                        permissionsInfo = 'query failed';
                    }
                }
                
                // Get device info
                let deviceInfo = 'Could not enumerate';
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const videoDevices = devices.filter(d => d.kind === 'videoinput');
                    deviceInfo = `${videoDevices.length} video devices found`;
                } catch (e) {
                    deviceInfo = `Error: ${e.message}`;
                }
                
                // Check HTTPS
                const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
                
                // Detect mobile
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                const isAndroid = /Android/i.test(navigator.userAgent);
                
                const debugHTML = `
                    <div style="background: rgba(99, 102, 241, 0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(99, 102, 241, 0.3);">
                        <h3 style="color: var(--accent-primary); margin-bottom: 15px;">üîç Debug Information</h3>
                        
                        <div style="text-align: left; font-family: monospace; font-size: 12px; line-height: 1.4;">
                            <strong>Environment:</strong><br>
                            ‚Ä¢ HTTPS: ${isSecure ? '‚úÖ' : '‚ùå'}<br>
                            ‚Ä¢ Mobile: ${isMobile ? '‚úÖ' : '‚ùå'}<br>
                            ‚Ä¢ iOS: ${isIOS ? '‚úÖ' : '‚ùå'}<br>
                            ‚Ä¢ Android: ${isAndroid ? '‚úÖ' : '‚ùå'}<br>
                            ‚Ä¢ Online: ${debugInfo.onLine ? '‚úÖ' : '‚ùå'}<br><br>
                            
                            <strong>Media Support:</strong><br>
                            ‚Ä¢ MediaDevices: ${mediaDevicesSupport.supported ? '‚úÖ' : '‚ùå'}<br>
                            ‚Ä¢ getUserMedia: ${mediaDevicesSupport.getUserMedia ? '‚úÖ' : '‚ùå'}<br>
                            ‚Ä¢ enumerateDevices: ${mediaDevicesSupport.enumerateDevices ? '‚úÖ' : '‚ùå'}<br><br>
                            
                            <strong>Camera:</strong><br>
                            ‚Ä¢ Devices: ${deviceInfo}<br>
                            ‚Ä¢ Permission: ${permissionsInfo}<br><br>
                            
                            <strong>Browser:</strong><br>
                            ‚Ä¢ ${navigator.userAgent.split(' ').slice(-3).join(' ')}<br>
                            ‚Ä¢ Platform: ${debugInfo.platform}<br>
                            ‚Ä¢ Language: ${debugInfo.language}<br><br>
                            
                            <strong>Connection:</strong><br>
                            ‚Ä¢ Type: ${debugInfo.connection.effectiveType || 'unknown'}<br>
                            ‚Ä¢ Speed: ${debugInfo.connection.downlink || 'unknown'} Mbps<br>
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button onclick="copyDebugInfo()" class="btn btn-secondary" style="margin-right: 10px;">
                                üìã Copy Debug Info
                            </button>
                            <button onclick="trySimpleCamera()" class="btn btn-primary">
                                üéØ Try Simple Camera
                            </button>
                        </div>
                    </div>
                `;
                
                showResult(debugHTML, 'info');
                
                // Store debug info globally for copying
                window.debugInfo = {
                    environment: { isSecure, isMobile, isIOS, isAndroid, online: debugInfo.onLine },
                    mediaSupport: mediaDevicesSupport,
                    camera: { devices: deviceInfo, permission: permissionsInfo },
                    browser: debugInfo.userAgent,
                    platform: debugInfo.platform,
                    connection: debugInfo.connection
                };
                
            } catch (error) {
                console.error('Debug info gathering failed:', error);
                showResult('‚ùå Could not gather debug information', 'error');
            }
        }
        
        // Copy debug info to clipboard
        function copyDebugInfo() {
            if (window.debugInfo) {
                const text = JSON.stringify(window.debugInfo, null, 2);
                navigator.clipboard?.writeText(text).then(() => {
                    showResult('üìã Debug info copied to clipboard!', 'success');
                }).catch(() => {
                    console.log('Debug info:', text);
                    showResult('Debug info logged to console (clipboard not available)', 'info');
                });
            }
        }
        
        // Simple camera access directly based on the Medium article approach
        async function trySimpleCamera() {
            try {
                updateStatus('üéØ Trying simple camera access...', 'info');
                console.log('Starting simple camera access...');
                
                // Use the exact approach from the article
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                
                console.log('Simple camera access successful!', stream);
                
                const video = document.getElementById('video');
                
                // Set essential attributes for mobile
                video.setAttribute('playsinline', 'true');
                video.setAttribute('autoplay', 'true');
                video.setAttribute('muted', 'true');
                
                video.srcObject = stream;
                
                // Wait for video to load
                video.addEventListener('loadedmetadata', () => {
                    console.log('Video metadata loaded, starting scan...');
                    video.play().then(() => {
                        console.log('Video is playing');
                        
                        // Set global variables
                        window.stream = stream;
                        
                        updateStatus('‚úÖ Simple camera connected!', 'success');
                        showResult(`
                            <div style="background: rgba(16, 185, 129, 0.1); padding: 20px; border-radius: 12px;">
                                <h3 style="color: #10b981;">‚úÖ Simple Camera Access Successful!</h3>
                                <p>Using direct camera access method.</p>
                                <p><strong>Video dimensions:</strong> ${video.videoWidth}x${video.videoHeight}</p>
                                <p>Ready to scan QR codes!</p>
                            </div>
                        `, 'success');
                        
                        // Start scanning with simple approach
                        startSimpleScanning(stream);
                        
                    }).catch(err => {
                        console.error('Video play failed:', err);
                        showResult('Video failed to play. Try allowing autoplay in browser settings.', 'error');
                    });
                });
                
            } catch (error) {
                console.error('Simple camera access failed:', error);
                updateStatus('‚ùå Simple camera access failed', 'error');
                
                let errorMsg = '‚ùå Simple Camera Access Failed<br><br>';
                
                if (error.name === 'NotAllowedError') {
                    errorMsg += '<strong>Permission Denied.</strong><br>Please allow camera access and try again.';
                } else if (error.name === 'NotFoundError') {
                    errorMsg += '<strong>No Camera Found.</strong><br>No environment camera available.';
                } else if (error.name === 'NotSupportedError') {
                    errorMsg += '<strong>Not Supported.</strong><br>Your browser doesn\'t support camera access.';
                } else {
                    errorMsg += `<strong>Error:</strong> ${error.message}`;
                }
                
                errorMsg += '<br><br>Try the regular scanner or manual verification.';
                showResult(errorMsg, 'error');
            }
        }
        
        // Simple scanning function with improved detection
        function startSimpleScanning(stream) {
            const video = document.getElementById('video');
            canvas = document.createElement('canvas');
            context = canvas.getContext('2d');
            
            scanning = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('captureBtn').disabled = false; // Enable capture button
            
            // Reset detection state
            detectionState.processingQR = false;
            detectionState.lastDetected = null;
            detectionState.consecutiveDetections = 0;
            
            updateStatus('üîç Scanning for QR codes...', 'scanning');
            
            function scan() {
                if (!scanning || detectionState.processingQR) return;
                
                try {
                    if (video.readyState === video.HAVE_ENOUGH_DATA) {
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        
                        context.drawImage(video, 0, 0, canvas.width, canvas.height);
                        
                        // Use the same improved detection method
                        const qrResult = tryQRDetection();
                        
                        if (qrResult && qrResult.data && qrResult.data.length > 20) {
                            handleQRDetection(qrResult.data);
                        } else {
                            // No QR detected, reset detection state
                            if (detectionState.consecutiveDetections > 0) {
                                detectionState.lastDetected = null;
                                detectionState.consecutiveDetections = 0;
                                updateStatus('üîç Scanning for QR codes...', 'scanning');
                            }
                        }
                    }
                } catch (error) {
                    console.error('Simple scanning error:', error);
                }
                
                if (scanning && !detectionState.processingQR) {
                    requestAnimationFrame(scan);
                }
            }
            
            // Start scanning when video is ready
            if (video.readyState >= video.HAVE_ENOUGH_DATA) {
                scan();
            } else {
                video.addEventListener('canplay', scan, { once: true });
            }
        }
        
        // Quick function to try back cameras first
        async function tryBackCamerasFirst() {
            try {
                updateStatus('üéØ Looking for back cameras...', 'info');
                
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                // Find back-facing cameras
                const backCameras = videoDevices.filter(device => 
                    device.label && (
                        device.label.toLowerCase().includes('back') ||
                        device.label.toLowerCase().includes('rear') ||
                        device.label.toLowerCase().includes('facing back') ||
                        device.label.toLowerCase().includes('camera 0') || // Often main camera
                        device.label.toLowerCase().includes('camera 2') ||
                        device.label.toLowerCase().includes('camera 3')
                    )
                );
                
                if (backCameras.length === 0) {
                    showResult('No back cameras identified. Trying standard detection...', 'info');
                    setTimeout(attemptCameraAccess, 1000);
                    return;
                }
                
                console.log('Found back cameras:', backCameras);
                
                // Try each back camera
                for (let i = 0; i < backCameras.length; i++) {
                    const camera = backCameras[i];
                    updateStatus(`üì∑ Trying back camera: ${camera.label}`, 'info');
                    
                    try {
                        const constraints = {
                            video: {
                                deviceId: { exact: camera.deviceId },
                                width: { min: 320, ideal: 640, max: 1280 },
                                height: { min: 240, ideal: 480, max: 720 }
                            }
                        };
                        
                        const cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                        
                        if (cameraStream && cameraStream.getVideoTracks().length > 0) {
                            const track = cameraStream.getVideoTracks()[0];
                            if (track.readyState === 'live') {
                                console.log('‚úÖ Back camera working:', camera.label);
                                
                                // Set up video
                                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                                const video = document.getElementById('video');
                                
                                if (isMobile) {
                                    video.setAttribute('playsinline', 'true');
                                    video.setAttribute('webkit-playsinline', 'true');
                                    video.muted = true;
                                    video.autoplay = true;
                                }
                                
                                video.srcObject = cameraStream;
                                stream = cameraStream;
                                
                                updateStatus('‚úÖ Back camera connected!', 'success');
                                showResult(`
                                    <div style="background: rgba(16, 185, 129, 0.1); padding: 20px; border-radius: 12px;">
                                        <h3 style="color: #10b981;">‚úÖ Back Camera Connected!</h3>
                                        <p><strong>Using:</strong> ${camera.label}</p>
                                        <p>Perfect for scanning QR codes!</p>
                                    </div>
                                `, 'success');
                                
                                startActualScanning(cameraStream);
                                return;
                            }
                        }
                    } catch (error) {
                        console.log(`Back camera ${camera.label} failed:`, error.message);
                        // Continue to next camera
                    }
                }
                
                // If no back cameras worked, try standard detection
                showResult('Back cameras not accessible. Trying all available cameras...', 'info');
                setTimeout(attemptCameraAccess, 1000);
                
            } catch (error) {
                console.error('Error trying back cameras:', error);
                attemptCameraAccess();
            }
        }
        
        // Manual camera selector for devices with multiple cameras
        async function showCameraSelector() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                let selectorHTML = `
                    <div style="background: rgba(99, 102, 241, 0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(99, 102, 241, 0.3);">
                        <h3 style="color: var(--accent-primary); margin-bottom: 15px;">üéØ Select Camera</h3>
                        <p>Your device has ${videoDevices.length} cameras. Try selecting a specific camera:</p>
                        
                        <div style="margin: 20px 0;">
                `;
                
                videoDevices.forEach((device, index) => {
                    const isBackCamera = device.label && (
                        device.label.toLowerCase().includes('back') ||
                        device.label.toLowerCase().includes('rear') ||
                        device.label.toLowerCase().includes('facing back') ||
                        device.label.toLowerCase().includes('camera 0')
                    );
                    
                    const cameraType = isBackCamera ? 'üì∑ (Recommended for QR scanning)' : 'ü§≥';
                    
                    selectorHTML += `
                        <button onclick="trySpecificCamera('${device.deviceId}', '${device.label || `Camera ${index + 1}`}')" 
                                class="btn btn-secondary" 
                                style="display: block; width: 100%; margin: 10px 0; text-align: left; padding: 15px;">
                            ${cameraType} ${device.label || `Camera ${index + 1}`}
                            <br><small style="opacity: 0.7;">ID: ${device.deviceId.substr(0, 20)}...</small>
                        </button>
                    `;
                });
                
                selectorHTML += `
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button onclick="attemptCameraAccess()" class="btn btn-primary" style="margin-right: 10px;">
                                üîÑ Try Auto-Detection Again
                            </button>
                            <button onclick="document.querySelector('.manual-entry').scrollIntoView({behavior: 'smooth'})" class="btn btn-secondary">
                                üìù Use Manual Entry
                            </button>
                        </div>
                    </div>
                `;
                
                showResult(selectorHTML, 'info');
                
            } catch (error) {
                console.error('Error showing camera selector:', error);
                showResult('‚ùå Error loading camera list. Please try the automatic detection.', 'error');
            }
        }
        
        // Try a specific camera by device ID
        async function trySpecificCamera(deviceId, deviceName) {
            try {
                updateStatus(`üì∑ Trying ${deviceName}...`, 'info');
                
                const constraints = {
                    video: {
                        deviceId: { exact: deviceId }
                    }
                };
                
                console.log(`Attempting specific camera: ${deviceName} (${deviceId})`);
                
                const cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                if (cameraStream && cameraStream.getVideoTracks().length > 0) {
                    const track = cameraStream.getVideoTracks()[0];
                    console.log('Specific camera access successful:', track.getSettings());
                    
                    // Set up video with mobile-specific configuration
                    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    const video = document.getElementById('video');
                    
                    if (isMobile) {
                        video.setAttribute('playsinline', 'true');
                        video.setAttribute('webkit-playsinline', 'true');
                        video.muted = true;
                        video.autoplay = true;
                    }
                    
                    video.srcObject = cameraStream;
                    stream = cameraStream;
                    
                    // Wait for video to load
                    await new Promise((resolve, reject) => {
                        const timeout = setTimeout(() => {
                            reject(new Error('Video load timeout'));
                        }, 10000);
                        
                        video.onloadedmetadata = () => {
                            clearTimeout(timeout);
                            video.play()
                                .then(() => {
                                    console.log('Video playing successfully');
                                    resolve();
                                })
                                .catch(err => {
                                    console.error('Video play failed:', err);
                                    resolve(); // Continue anyway
                                });
                        };
                        
                        setTimeout(() => {
                            if (video.readyState >= 2) {
                                clearTimeout(timeout);
                                resolve();
                            }
                        }, 2000);
                    });
                    
                    const settings = track.getSettings();
                    
                    updateStatus('‚úÖ Camera connected successfully!', 'success');
                    showResult(`
                        <div style="background: rgba(16, 185, 129, 0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(16, 185, 129, 0.3);">
                            <h3 style="color: #10b981; margin-bottom: 15px;">‚úÖ Camera "${deviceName}" Connected!</h3>
                            <div style="text-align: left;">
                                <strong>Camera Details:</strong><br>
                                ‚Ä¢ Device: ${deviceName}<br>
                                ‚Ä¢ Resolution: ${settings.width || 'auto'}x${settings.height || 'auto'}<br>
                                ‚Ä¢ Frame Rate: ${settings.frameRate || 'auto'} fps<br>
                                ‚Ä¢ Facing Mode: ${settings.facingMode || 'unknown'}<br><br>
                                
                                <strong>Ready to scan QR codes!</strong><br>
                                Position a QR code in the camera view to verify tickets.
                            </div>
                        </div>
                    `, 'success');
                    
                    startActualScanning(cameraStream);
                }
                
            } catch (error) {
                console.error(`Error accessing camera ${deviceName}:`, error);
                updateStatus(`‚ùå Failed to access ${deviceName}`, 'error');
                
                let errorMsg = `‚ùå Failed to access "${deviceName}"<br><br>`;
                
                if (error.name === 'NotAllowedError') {
                    errorMsg += 'Permission denied. Please allow camera access and try again.';
                } else if (error.name === 'NotReadableError') {
                    errorMsg += 'Camera is busy or being used by another application.';
                } else {
                    errorMsg += `Error: ${error.message}`;
                }
                
                showResult(errorMsg + '<br><br>Try selecting a different camera or use the manual entry option.', 'error');
            }
        }
        
        // Enhanced camera detection and debugging
        async function debugCameraDevices() {
            updateStatus('üîç Detecting cameras...', 'info');
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (!isMobile) return true;
            
            try {
                // Try to enumerate devices first
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                if (videoDevices.length === 0) {
                    return false;
                }
                
                // Check if we can access camera permissions
                if (navigator.permissions && navigator.permissions.query) {
                    try {
                        const permission = await navigator.permissions.query({ name: 'camera' });
                        console.log('Camera permission state:', permission.state);
                        return permission.state !== 'denied';
                    } catch (e) {
                        // Permissions API not supported, assume we can try
                        return true;
                    }
                }
                
                return true;
            } catch (error) {
                console.error('Mobile permission check failed:', error);
                return true; // Assume we can try
            }
        }
        
        // Camera detection and debugging
        async function debugCameraDevices() {
            updateStatus('üîç Detecting cameras...', 'info');
            
            // Check mobile permissions first
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile) {
                const hasPermissions = await checkMobilePermissions();
                if (!hasPermissions) {
                    showResult(`
                        <div style="background: rgba(239, 68, 68, 0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(239, 68, 68, 0.3);">
                            <h3 style="color: #ef4444; margin-bottom: 15px;">üì± Mobile Permission Issue</h3>
                            <p>Camera permissions may be blocked on your mobile device.</p>
                            
                            <div style="text-align: left; margin: 15px 0;">
                                <strong>Steps to enable camera:</strong><br>
                                1. Look for camera/permission icon in your browser's address bar<br>
                                2. Tap it and allow camera access<br>
                                3. Refresh this page<br><br>
                                
                                <strong>If no icon appears:</strong><br>
                                ‚Ä¢ Clear browser cache and reload<br>
                                ‚Ä¢ Try using Chrome or Safari<br>
                                ‚Ä¢ Check your device's camera app works first
                            </div>
                            
                            <div style="text-align: center; margin-top: 20px;">
                                <button onclick="location.reload()" class="btn btn-primary" style="margin-right: 10px;">
                                    üîÑ Reload & Try Again
                                </button>
                                <button onclick="document.querySelector('.manual-entry').scrollIntoView({behavior: 'smooth'})" class="btn btn-secondary">
                                    üìù Use Manual Entry
                                </button>
                            </div>
                        </div>
                    `, 'error');
                    return;
                }
            }
            
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                console.log('All devices:', devices);
                console.log('Video devices:', videoDevices);
                
                let debugInfo = `
                    <div style="background: rgba(99, 102, 241, 0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(99, 102, 241, 0.3);">
                        <h3 style="color: var(--accent-primary); margin-bottom: 15px;">üîç Camera Detection Results</h3>
                        
                        <div style="text-align: left; margin: 15px 0;">
                            <strong>Total Devices Found:</strong> ${devices.length}<br>
                            <strong>Video Devices Found:</strong> ${videoDevices.length}<br><br>
                            
                            <strong>Device Details:</strong><br>
                `;
                
                if (videoDevices.length === 0) {
                    debugInfo += `
                        <span style="color: #ef4444;">‚ùå No video devices detected</span><br><br>
                        
                        <strong>Possible Causes:</strong><br>
                        ‚Ä¢ Camera is being used by another app<br>
                        ‚Ä¢ Camera drivers not installed<br>
                        ‚Ä¢ Hardware camera disabled<br>
                        ‚Ä¢ Browser security restrictions<br><br>
                        
                        <strong>Solutions to Try:</strong><br>
                        1. Close all other apps that might use camera<br>
                        2. Restart your browser completely<br>
                        3. Try a different browser (Chrome, Firefox, Safari)<br>
                        4. Check if camera works in other apps<br>
                        5. Restart your device<br>
                    `;
                } else {
                    videoDevices.forEach((device, index) => {
                        debugInfo += `
                            ${index + 1}. <strong>${device.label || 'Camera ' + (index + 1)}</strong><br>
                            &nbsp;&nbsp;&nbsp;ID: ${device.deviceId}<br>
                            &nbsp;&nbsp;&nbsp;Group: ${device.groupId}<br><br>
                        `;
                    });
                    
                    debugInfo += `
                        <div style="margin-top: 15px; padding: 15px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border: 1px solid rgba(16, 185, 129, 0.3);">
                            <strong>‚úÖ Cameras detected! Attempting automatic access...</strong>
                        </div>
                    `;
                    
                    // For devices with many cameras, show manual selection option
                    if (videoDevices.length > 4) {
                        debugInfo += `
                            <div style="margin-top: 15px; padding: 15px; background: rgba(255, 193, 7, 0.1); border-radius: 8px; border: 1px solid rgba(255, 193, 7, 0.3);">
                                <strong>‚ö†Ô∏è Multiple Cameras Detected (${videoDevices.length})</strong><br>
                                If automatic selection fails, you can try specific cameras below.
                            </div>
                        `;
                    }
                }
                
                debugInfo += `
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button onclick="attemptCameraAccess()" class="btn btn-primary" style="margin-right: 10px;">
                                üì∑ Try Camera Access
                            </button>`;
                
                // Add manual camera selection for devices with many cameras
                if (videoDevices.length > 4) {
                    debugInfo += `
                            <button onclick="showCameraSelector()" class="btn btn-secondary" style="margin-right: 10px;">
                                üéØ Select Specific Camera
                            </button>`;
                }
                
                debugInfo += `
                            <button onclick="document.querySelector('.manual-entry').scrollIntoView({behavior: 'smooth'})" class="btn btn-secondary">
                                üìù Use Manual Entry
                            </button>
                        </div>
                    </div>
                `;
                
                showResult(debugInfo, 'info');
                
                // If cameras found, try to access them
                if (videoDevices.length > 0) {
                    setTimeout(() => attemptCameraAccess(), 2000);
                }
                
            } catch (error) {
                console.error('Device enumeration failed:', error);
                showResult(`
                    <div style="background: rgba(239, 68, 68, 0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(239, 68, 68, 0.3);">
                        <h3 style="color: #ef4444; margin-bottom: 15px;">‚ùå Camera Detection Failed</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p style="margin-top: 15px;"><strong>This usually means:</strong></p>
                        <ul style="text-align: left; margin: 10px 0;">
                            <li>Browser doesn't support camera access</li>
                            <li>Device has no camera hardware</li>
                            <li>Severe permission restrictions</li>
                        </ul>
                        <div style="text-align: center; margin-top: 20px;">
                            <button onclick="document.querySelector('.manual-entry').scrollIntoView({behavior: 'smooth'})" class="btn btn-primary">
                                üìù Use Manual Verification
                            </button>
                        </div>
                    </div>
                `, 'error');
            }
        }
        
        // Simplified mobile-first camera access based on best practices
        async function attemptCameraAccess() {
            try {
                updateStatus('üîê Requesting camera permission...', 'info');
                
                // Detect mobile devices
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                
                console.log('Device detection:', { isMobile, isIOS });
                
                // Progressive constraint options - start with the most basic working options
                const constraintOptions = [
                    // Option 1: Simplest environment camera (as recommended in the article)
                    {
                        video: { facingMode: 'environment' }
                    },
                    // Option 2: Even simpler - just any camera
                    {
                        video: true
                    },
                    // Option 3: Explicit back camera with basic constraints
                    {
                        video: {
                            facingMode: { ideal: 'environment' },
                            width: { ideal: 640 },
                            height: { ideal: 480 }
                        }
                    },
                    // Option 4: Front camera fallback
                    {
                        video: { facingMode: 'user' }
                    }
                ];
                
                // For devices with many cameras, add specific device attempts
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const videoDevices = devices.filter(device => device.kind === 'videoinput');
                    
                    console.log('Found video devices:', videoDevices.length);
                    
                    if (videoDevices.length > 4) {
                        // Add specific device constraints for first few cameras
                        for (let i = 0; i < Math.min(3, videoDevices.length); i++) {
                            constraintOptions.unshift({
                                video: { deviceId: videoDevices[i].deviceId }
                            });
                        }
                    }
                } catch (e) {
                    console.log('Could not enumerate devices, using basic constraints');
                }
                
                let cameraStream = null;
                let workingConstraint = null;
                
                // Add delay for iOS devices
                if (isIOS) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                console.log(`Trying ${constraintOptions.length} camera options...`);
                
                for (let i = 0; i < constraintOptions.length; i++) {
                    try {
                        updateStatus(`üì∑ Trying camera ${i + 1}/${constraintOptions.length}...`, 'info');
                        console.log(`Attempt ${i + 1}:`, constraintOptions[i]);
                        
                        // Add delay between attempts for mobile
                        if (i > 0) {
                            await new Promise(resolve => setTimeout(resolve, 800));
                        }
                        
                        // Request camera access
                        cameraStream = await navigator.mediaDevices.getUserMedia(constraintOptions[i]);
                        
                        // Verify the stream is working
                        if (cameraStream && cameraStream.getVideoTracks().length > 0) {
                            const track = cameraStream.getVideoTracks()[0];
                            console.log('Got video track:', {
                                readyState: track.readyState,
                                enabled: track.enabled,
                                muted: track.muted,
                                settings: track.getSettings()
                            });
                            
                            if (track.readyState === 'live' && track.enabled) {
                                workingConstraint = constraintOptions[i];
                                console.log('‚úÖ Camera stream is working!');
                                break;
                            } else {
                                console.log('Stream not ready, stopping and trying next...');
                                cameraStream.getTracks().forEach(t => t.stop());
                                cameraStream = null;
                            }
                        }
                    } catch (error) {
                        console.log(`Option ${i + 1} failed:`, {
                            name: error.name,
                            message: error.message,
                            constraint: constraintOptions[i]
                        });
                        
                        // Special handling for different errors
                        if (error.name === 'NotAllowedError') {
                            // Permission denied - might be final
                            if (i === constraintOptions.length - 1) {
                                throw error;
                            }
                        } else if (error.name === 'OverconstrainedError') {
                            // This constraint doesn't work, try next
                            continue;
                        } else if (error.name === 'NotFoundError' || error.name === 'NotReadableError') {
                            // Device issues - try simpler constraints
                            continue;
                        } else if (i === constraintOptions.length - 1) {
                            // Last option failed
                            throw error;
                        }
                    }
                }
                
                if (cameraStream && workingConstraint) {
                    console.log('Setting up video element...');
                    const video = document.getElementById('video');
                    
                    // Enhanced mobile video setup
                    video.setAttribute('playsinline', 'true');
                    video.setAttribute('webkit-playsinline', 'true');
                    video.setAttribute('autoplay', 'true');
                    video.setAttribute('muted', 'true');
                    video.style.width = '100%';
                    video.style.height = 'auto';
                    
                    // Set video source
                    video.srcObject = cameraStream;
                    stream = cameraStream;
                    
                    // Wait for video to be ready
                    await new Promise((resolve, reject) => {
                        const timeout = setTimeout(() => {
                            console.log('Video setup timeout, continuing anyway...');
                            resolve();
                        }, 5000);
                        
                        const onReady = () => {
                            clearTimeout(timeout);
                            console.log('Video is ready:', {
                                readyState: video.readyState,
                                videoWidth: video.videoWidth,
                                videoHeight: video.videoHeight
                            });
                            resolve();
                        };
                        
                        if (video.readyState >= 2) {
                            onReady();
                        } else {
                            video.addEventListener('loadedmetadata', onReady, { once: true });
                            video.addEventListener('canplay', onReady, { once: true });
                        }
                    });
                    
                    // Force play for mobile
                    try {
                        await video.play();
                        console.log('Video is playing');
                    } catch (playError) {
                        console.log('Video play failed, but continuing:', playError);
                    }
                    
                    const track = cameraStream.getVideoTracks()[0];
                    const settings = track.getSettings();
                    
                    updateStatus('‚úÖ Camera connected successfully!', 'success');
                    showResult(`
                        <div style="background: rgba(16, 185, 129, 0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(16, 185, 129, 0.3);">
                            <h3 style="color: #10b981; margin-bottom: 15px;">‚úÖ Camera Connected Successfully!</h3>
                            <div style="text-align: left;">
                                <strong>Camera Details:</strong><br>
                                ‚Ä¢ Device: ${track.label || 'Camera'}<br>
                                ‚Ä¢ Resolution: ${settings.width || video.videoWidth || 'auto'}x${settings.height || video.videoHeight || 'auto'}<br>
                                ‚Ä¢ Facing: ${settings.facingMode || 'unknown'}<br>
                                ‚Ä¢ Working Constraint: ${JSON.stringify(workingConstraint).replace(/"/g, '')}<br><br>
                                
                                <strong>üéØ Ready to scan QR codes!</strong><br>
                                Position a QR code clearly in the camera view.
                            </div>
                        </div>
                    `, 'success');
                    
                    // Start scanning
                    startActualScanning(cameraStream);
                    
                } else {
                    throw new Error('No camera stream available after all attempts');
                }
                
            } catch (error) {
                console.error('All camera access attempts failed:', error);
                handleCameraError(error);
            }
        }
        
        // Enhanced camera error handling with mobile-specific solutions
        async function handleCameraError(error) {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isAndroid = /Android/i.test(navigator.userAgent);
            
            let errorMessage = '‚ùå Camera Access Failed<br><br>';
            let troubleshooting = '';
            
            if (error.name === 'NotAllowedError') {
                errorMessage += '<strong>Permission Denied:</strong> Camera access was blocked.<br><br>';
                
                if (isMobile) {
                    troubleshooting = `
                        <strong>üì± Mobile Solutions:</strong><br><br>
                        
                        <strong>For Chrome Mobile:</strong><br>
                        1. Look for camera icon (üì∑) or lock icon (ÔøΩ) in address bar<br>
                        2. Tap it and select "Allow" for camera<br>
                        3. Refresh this page<br><br>
                        
                        <strong>For Brave Browser:</strong><br>
                        1. Look for shield icon (ÔøΩÔ∏è) in address bar<br>
                        2. Tap it and enable "Camera"<br>
                        3. Refresh this page<br><br>
                        
                        <strong>For Safari (iOS):</strong><br>
                        1. When prompted, tap "Allow"<br>
                        2. If no prompt: Settings > Safari > Camera > Allow<br>
                        3. Return and refresh this page<br><br>
                        
                        <strong>For Firefox Mobile:</strong><br>
                        1. Tap the shield or lock icon in address bar<br>
                        2. Enable camera permissions<br>
                        3. Reload the page<br><br>
                    `;
                } else {
                    troubleshooting = `
                        <strong>Desktop Solutions:</strong><br>
                        1. Click camera icon in address bar and allow access<br>
                        2. Check browser settings > Privacy > Camera<br>
                        3. Ensure no other app is using the camera<br><br>
                    `;
                }
            } else if (error.name === 'NotFoundError') {
                errorMessage += '<strong>No Camera Found:</strong> No camera detected on this device.<br><br>';
                troubleshooting = `
                    <strong>Possible Solutions:</strong><br>
                    1. Check if another app is using the camera<br>
                    2. Close all camera apps and try again<br>
                    3. Restart your browser${isMobile ? ' completely' : ''}<br>
                    4. Restart your device<br>
                    ${isMobile ? '5. Try using a different browser (Chrome recommended)<br>' : ''}
                    ${isAndroid ? '6. Check if camera works in your device\'s camera app<br>' : ''}
                `;
            } else if (error.name === 'NotSupportedError' || error.name === 'TypeError') {
                errorMessage += '<strong>Not Supported:</strong> Camera not supported in this browser or context.<br><br>';
                troubleshooting = `
                    <strong>Solutions:</strong><br>
                    1. Try these browsers: Chrome, Firefox, Safari, Edge<br>
                    2. Ensure you're using HTTPS (not HTTP)<br>
                    3. Update your browser to the latest version<br>
                    ${isMobile ? '4. Clear browser cache and cookies<br>' : ''}
                    ${isIOS ? '5. For iOS: Use Safari or Chrome, avoid third-party browsers<br>' : ''}
                `;
            } else if (error.name === 'NotReadableError') {
                errorMessage += '<strong>Camera Busy:</strong> Camera is being used by another application.<br><br>';
                troubleshooting = `
                    <strong>Solutions:</strong><br>
                    1. Close all other apps using the camera<br>
                    2. Close other browser tabs with camera access<br>
                    3. Force-close your browser and reopen<br>
                    4. Restart your device if the issue persists<br>
                    ${isMobile ? '5. Check if camera app is running in background<br>' : ''}
                `;
            } else if (error.name === 'OverconstrainedError') {
                errorMessage += '<strong>Camera Constraints:</strong> Your camera doesn\'t support the required settings.<br><br>';
                troubleshooting = `
                    <strong>This is usually resolved automatically, but you can try:</strong><br>
                    1. Refresh the page to retry with simpler settings<br>
                    2. Try a different browser<br>
                    3. Update your device drivers (desktop)<br>
                    ${isMobile ? '4. Clear browser data and try again<br>' : ''}
                `;
            } else {
                errorMessage += `<strong>Unexpected Error:</strong> ${error.message}<br><br>`;
                troubleshooting = `
                    <strong>General Troubleshooting:</strong><br>
                    1. Refresh the page and try again<br>
                    2. Clear browser cache and cookies<br>
                    3. Try a different browser (Chrome recommended)<br>
                    4. Restart your device<br>
                    ${isMobile ? '5. Ensure you\'re using the latest browser version<br>' : ''}
                    ${isIOS ? '6. For iOS: Try using Safari instead of other browsers<br>' : ''}
                `;
            }
            
            updateStatus('Camera access failed - Use manual verification', 'error');
            
            // Special message for devices with many cameras
            const devices = await navigator.mediaDevices.enumerateDevices().catch(() => []);
            const videoDevices = devices.filter(device => device.kind === 'videoinput');
            
            if (videoDevices.length > 4) {
                troubleshooting += `
                    <div style="margin-top: 20px; padding: 15px; background: rgba(255, 193, 7, 0.1); border-radius: 8px; border: 1px solid rgba(255, 193, 7, 0.3);">
                        <strong>‚ö†Ô∏è Multiple Cameras Detected (${videoDevices.length})</strong><br>
                        Your device has many cameras. Try these specific solutions:<br>
                        1. Use the "Try Back Cameras First" button above<br>
                        2. Try the "Select Specific Camera" option<br>
                        3. Close any other apps that might be using cameras<br>
                        4. Restart your browser completely<br>
                    </div>
                `;
            }
            
            showResult(`
                <div style="background: rgba(239, 68, 68, 0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(239, 68, 68, 0.3);">
                    <h3 style="color: #ef4444; margin-bottom: 15px;">üì∑ Camera Issue</h3>
                    <div style="margin-bottom: 15px;">${errorMessage}</div>
                    <div style="text-align: left; margin-bottom: 20px;">${troubleshooting}</div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: rgba(99, 102, 241, 0.1); border-radius: 8px;">
                        <strong>üí° Alternative:</strong> Manual verification works perfectly without camera access. Scroll down to use it.
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="location.reload()" class="btn btn-primary" style="margin-right: 10px;">
                            üîÑ Refresh & Try Again
                        </button>
                        <button onclick="document.querySelector('.manual-entry').scrollIntoView({behavior: 'smooth'})" class="btn btn-secondary">
                            üìù Use Manual Entry
                        </button>
                    </div>
                </div>
            `, 'error');
            
            setTimeout(() => {
                document.querySelector('.manual-entry').scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start'
                });
            }, 2000);
        }
        
        // Start actual scanning
        function startActualScanning(cameraStream) {
            canvas = document.createElement('canvas');
            context = canvas.getContext('2d');
            
            scanning = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('captureBtn').disabled = false; // Enable capture button
            
            // Reset detection state
            detectionState.processingQR = false;
            detectionState.lastDetected = null;
            detectionState.consecutiveDetections = 0;
            
            updateStatus('üì± Scanner active - Position QR code in the frame', 'scanning');
            requestAnimationFrame(scanQRCode);
        }
        
        // Enhanced main scanner function with reliable camera initialization
        async function startScanner() {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile) {
                updateStatus('üì± Initializing mobile camera...', 'info');
            } else {
                updateStatus('üñ•Ô∏è Initializing desktop camera...', 'info');
            }
            
            try {
                // Initialize camera and start scanning immediately
                await initializeCamera();
                
            } catch (error) {
                console.error('Camera initialization failed:', error);
                updateStatus('‚ùå Camera initialization failed', 'error');
                showResult('‚ùå Failed to access camera. Please check permissions and try again.', 'error');
            }
        }
        
        // Initialize camera with proper constraints for reliable operation
        async function initializeCamera() {
            try {
                updateStatus('üîç Accessing camera...', 'info');
                
                // Set the video element from the DOM
                if (!video) {
                    video = document.getElementById('video');
                    if (!video) {
                        throw new Error('Video element not found in DOM');
                    }
                }
                
                // Use constraints that work well across devices
                const constraints = {
                    video: {
                        facingMode: 'environment', // Use back camera on mobile
                        width: { ideal: 1280, max: 1920 },
                        height: { ideal: 720, max: 1080 },
                        frameRate: { ideal: 30, max: 60 }
                    }
                };
                
                // Get media stream
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                // Wait for video to be ready and start scanning immediately
                return new Promise((resolve, reject) => {
                    video.onloadedmetadata = () => {
                        video.play().then(() => {
                            console.log('‚úÖ Camera initialized and playing');
                            console.log('Video dimensions:', video.videoWidth, 'x', video.videoHeight);
                            
                            // Enable UI controls
                            document.getElementById('startBtn').disabled = true;
                            document.getElementById('stopBtn').disabled = false;
                            document.getElementById('captureBtn').disabled = false;
                            
                            // Reset detection state
                            resetDetectionState();
                            
                            // Start scanning immediately
                            scanning = true;
                            updateStatus('üì± Camera ready - scanning for QR codes...', 'scanning');
                            
                            // Start the scanning loop
                            requestAnimationFrame(scanQRCode);
                            
                            resolve();
                        }).catch(reject);
                    };
                    
                    video.onerror = reject;
                    
                    // Timeout after 10 seconds
                    setTimeout(() => reject(new Error('Camera initialization timeout')), 10000);
                });
                
            } catch (error) {
                console.error('Camera access failed:', error);
                throw error;
            }
        }
        
        // Reset detection state for fresh scanning
        function resetDetectionState() {
            detectionState.processingQR = false;
            detectionState.lastDetected = null;
            detectionState.consecutiveDetections = 0;
            detectionState.lastProcessTime = 0;
        }
        
        // Debug camera status for troubleshooting
        function debugCameraStatus() {
            if (!video) {
                console.log('‚ùå Video element not found');
                return false;
            }
            
            console.log('üîç Camera Debug Info:');
            console.log('  - Video element exists:', !!video);
            console.log('  - Video readyState:', video.readyState);
            console.log('  - Video states:', {
                HAVE_NOTHING: video.HAVE_NOTHING,
                HAVE_METADATA: video.HAVE_METADATA, 
                HAVE_CURRENT_DATA: video.HAVE_CURRENT_DATA,
                HAVE_FUTURE_DATA: video.HAVE_FUTURE_DATA,
                HAVE_ENOUGH_DATA: video.HAVE_ENOUGH_DATA
            });
            console.log('  - Video dimensions:', video.videoWidth + 'x' + video.videoHeight);
            console.log('  - Video playing:', !video.paused && !video.ended);
            console.log('  - Stream active:', video.srcObject && video.srcObject.active);
            console.log('  - Scanning active:', scanning);
            
            return video.readyState >= video.HAVE_CURRENT_DATA && video.videoWidth > 0;
        }
        
        // Enhanced capture function that works reliably and resumes scanning
        function captureAndScan() {
            // Debug camera status first
            const cameraReady = debugCameraStatus();
            
            // Check if video element exists and is ready
            if (!video) {
                showResult('‚ùå Camera not initialized. Please start the scanner first.', 'error');
                return;
            }
            
            // Check video readiness - be more flexible with ready states
            if (video.readyState < video.HAVE_CURRENT_DATA) {
                showResult(`‚ùå Camera not ready. Current state: ${video.readyState}. Please wait for camera to load properly.`, 'error');
                return;
            }
            
            // Check if video has dimensions
            if (video.videoWidth === 0 || video.videoHeight === 0) {
                showResult('‚ùå Camera feed not available. Please check camera permissions.', 'error');
                return;
            }
            
            updateStatus('üì∏ Capturing image...', 'info');
            
            try {
                // Create capture canvas
                const captureCanvas = document.createElement('canvas');
                const captureContext = captureCanvas.getContext('2d');
                
                // Set canvas size to match video
                captureCanvas.width = video.videoWidth;
                captureCanvas.height = video.videoHeight;
                
                console.log('Capture canvas size:', captureCanvas.width, 'x', captureCanvas.height);
                
                // Draw current video frame
                captureContext.drawImage(video, 0, 0, captureCanvas.width, captureCanvas.height);
                
                // Process the captured image for QR codes immediately
                updateStatus('üîç Analyzing captured image...', 'info');
                
                // Get image data and try QR detection
                const imageData = captureContext.getImageData(0, 0, captureCanvas.width, captureCanvas.height);
                
                try {
                    const qrResult = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: "dontInvert",
                    });
                    
                    if (qrResult && qrResult.data && qrResult.data.length > 20) {
                        console.log('QR found in captured image:', qrResult.data.substring(0, 50) + '...');
                        updateStatus('‚úÖ QR code found in capture!', 'success');
                        
                        // Process the QR immediately
                        processConfirmedQR(qrResult.data);
                        
                    } else {
                        updateStatus('‚ùå No QR code found in capture', 'error');
                        showResult(`
                            <div style="background: rgba(239, 68, 68, 0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(239, 68, 68, 0.3);">
                                <h3 style="color: #ef4444; margin-bottom: 15px;">üì∏ No QR Code Found</h3>
                                <p>The captured image doesn't contain a readable QR code.</p>
                                
                                <div style="text-align: left; margin: 15px 0;">
                                    <strong>Tips for better capture:</strong><br>
                                    ‚Ä¢ Ensure QR code is clearly visible and well-lit<br>
                                    ‚Ä¢ Hold device steady<br>
                                    ‚Ä¢ Make sure QR code fills a good portion of the frame<br>
                                    ‚Ä¢ Try different angles or distances<br>
                                    ‚Ä¢ Check if QR code is damaged or blurry<br>
                                </div>
                                
                                <div style="text-align: center; margin-top: 20px;">
                                    <button onclick="captureAndScan()" class="btn btn-primary" style="margin-right: 10px;">
                                        üì∏ Try Capture Again
                                    </button>
                                    <button onclick="resumeScanning()" class="btn btn-secondary">
                                        ÔøΩ Resume Auto Scan
                                    </button>
                                </div>
                            </div>
                        `, 'error');
                        
                        // Auto-resume scanning after 3 seconds if no action taken
                        setTimeout(() => {
                            if (!detectionState.processingQR) {
                                resumeScanning();
                            }
                        }, 3000);
                    }
                } catch (jsQRError) {
                    console.error('jsQR detection failed:', jsQRError);
                    updateStatus('‚ùå QR detection failed', 'error');
                    showResult('‚ùå Failed to analyze captured image. Try again or resume auto scanning.', 'error');
                    
                    // Resume scanning after error
                    setTimeout(() => {
                        resumeScanning();
                    }, 2000);
                }
                
            } catch (error) {
                console.error('Error during capture and scan:', error);
                updateStatus('‚ùå Capture failed', 'error');
                showResult('‚ùå Failed to capture image. Please try again.', 'error');
                
                // Resume scanning after error
                setTimeout(() => {
                    resumeScanning();
                }, 2000);
            }
        }
        
        // Show capture preview (enhanced version)
        function showCapturePreview(captureCanvas) {
            try {
                // Convert canvas to image data URL for preview
                const imageDataUrl = captureCanvas.toDataURL('image/jpeg', 0.8);
                
                // Show immediate visual feedback
                console.log('üì∏ Capture successful - analyzing...');
                
                // Optional: Show preview in result area temporarily
                setTimeout(() => {
                    showResult(`
                        <div style="background: rgba(99, 102, 241, 0.1); padding: 15px; border-radius: 12px; border: 1px solid rgba(99, 102, 241, 0.3);">
                            <h3 style="color: var(--accent-primary); margin-bottom: 10px;">üì∏ Analyzing Capture</h3>
                            <div style="text-align: center;">
                                <img src="${imageDataUrl}" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 1px solid #ccc;" alt="Captured image">
                            </div>
                            <p style="text-align: center; margin: 10px 0; font-size: 14px;">
                                üîç Scanning for QR codes...
                            </p>
                        </div>
                    `, 'info');
                }, 100);
                
            } catch (error) {
                console.log('Preview generation failed:', error);
            }
        }
        
        // Show capture preview
        function showCapturePreview(captureCanvas) {
            try {
                // Convert canvas to image data URL
                const imageDataUrl = captureCanvas.toDataURL('image/jpeg', 0.8);
                
                // Create preview in result area
                showResult(`
                    <div style="background: rgba(99, 102, 241, 0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(99, 102, 241, 0.3);">
                        <h3 style="color: var(--accent-primary); margin-bottom: 15px;">üì∏ Image Captured</h3>
                        
                        <div style="text-align: center; margin: 15px 0;">
                            <img src="${imageDataUrl}" style="max-width: 100%; max-height: 300px; border-radius: 8px; border: 1px solid #ccc;" alt="Captured image">
                        </div>
                        
                        <p style="text-align: center; margin: 10px 0;">
                            <strong>Analyzing for QR codes...</strong>
                        </p>
                        
                        <div style="text-align: center; margin-top: 15px;">
                            <button onclick="captureAndScan()" class="btn btn-secondary" style="margin-right: 10px;">
                                üì∏ Capture Again
                            </button>
                            <button onclick="downloadCapture('${imageDataUrl}')" class="btn btn-secondary">
                                üíæ Download Image
                            </button>
                        </div>
                    </div>
                `, 'info');
                
            } catch (error) {
                console.error('Error showing capture preview:', error);
            }
        }
        
        // Download captured image
        function downloadCapture(imageDataUrl) {
            try {
                const link = document.createElement('a');
                link.download = `qr-capture-${new Date().getTime()}.jpg`;
                link.href = imageDataUrl;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showResult('üì• Image downloaded successfully!', 'success');
            } catch (error) {
                console.error('Error downloading image:', error);
                showResult('‚ùå Failed to download image', 'error');
            }
        }
        
        // Enhanced stop scanner function
        function stopScanner() {
            scanning = false;
            
            // Reset detection state
            detectionState.processingQR = false;
            detectionState.lastDetected = null;
            detectionState.consecutiveDetections = 0;
            
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            if (video) {
                video.srcObject = null;
            }
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('captureBtn').disabled = true;
            
            updateStatus('Scanner stopped', 'info');
            document.getElementById('resultSection').style.display = 'none';
        }
        
        // Enhanced and more reliable QR code scanning  
        let detectionState = {
            lastDetected: null,
            consecutiveDetections: 0,
            processingQR: false,
            requiredDetections: 2, // Reduced for faster detection
            lastScanTime: 0
        };
        
        function scanQRCode() {
            if (!scanning || !video || detectionState.processingQR) return;
            
            try {
                // Check multiple video ready states for broader compatibility
                const isVideoReady = video.readyState >= video.HAVE_CURRENT_DATA && 
                                   video.videoWidth > 0 && video.videoHeight > 0;
                
                if (isVideoReady) {
                    // Throttle scanning to 10fps for better performance
                    const now = Date.now();
                    if (now - detectionState.lastScanTime < 100) {
                        requestAnimationFrame(scanQRCode);
                        return;
                    }
                    detectionState.lastScanTime = now;
                    
                    // Create canvas if needed
                    if (!canvas) {
                        canvas = document.createElement('canvas');
                        context = canvas.getContext('2d');
                    }
                    
                    // Set canvas dimensions to match video
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    
                    // Draw current video frame
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    // Try QR detection
                    const qrResult = tryQRDetection();
                    
                    if (qrResult && qrResult.data && qrResult.data.length > 20) {
                        handleQRDetection(qrResult.data);
                    } else {
                        // Reset detection state if no QR found
                        if (detectionState.consecutiveDetections > 0) {
                            detectionState.lastDetected = null;
                            detectionState.consecutiveDetections = 0;
                        }
                    }
                }
            } catch (error) {
                console.error('Error during QR scanning:', error);
            }
            
            // Continue scanning if still active and not processing
            if (scanning && !detectionState.processingQR) {
                requestAnimationFrame(scanQRCode);
            }
        }
        
        // Handle QR detection with improved reliability
        function handleQRDetection(qrData) {
            // Check if this is the same QR as last detected
            if (detectionState.lastDetected === qrData) {
                detectionState.consecutiveDetections++;
            } else {
                detectionState.lastDetected = qrData;
                detectionState.consecutiveDetections = 1;
            }
            
            // Process QR if we have enough consecutive detections
            if (detectionState.consecutiveDetections >= detectionState.requiredDetections) {
                console.log('‚úÖ QR code confirmed after', detectionState.consecutiveDetections, 'detections');
                updateStatus('‚úÖ QR Code detected - Processing...', 'success');
                
                // Stop further detection during processing
                detectionState.processingQR = true;
                
                // Process the QR code
                processConfirmedQR(qrData);
            } else {
                updateStatus(`üîç QR detected (${detectionState.consecutiveDetections}/${detectionState.requiredDetections})...`, 'scanning');
            }
        }
        
        // Try multiple QR detection methods
        function tryQRDetection() {
            const width = canvas.width;
            const height = canvas.height;
            
            // Method 1: Standard detection with both inversions
            try {
                const imageData = context.getImageData(0, 0, width, height);
                const result = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "attemptBoth"
                });
                if (result && result.data) return result;
            } catch (e) {
                console.log('Standard detection failed:', e);
            }
            
            // Method 2: Center region detection (where QR codes are usually held)
            try {
                const centerSize = 0.6; // 60% of the frame
                const startX = Math.floor(width * (1 - centerSize) / 2);
                const startY = Math.floor(height * (1 - centerSize) / 2);
                const regionWidth = Math.floor(width * centerSize);
                const regionHeight = Math.floor(height * centerSize);
                
                if (regionWidth > 150 && regionHeight > 150) {
                    const imageData = context.getImageData(startX, startY, regionWidth, regionHeight);
                    const result = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: "attemptBoth"
                    });
                    if (result && result.data) return result;
                }
            } catch (e) {
                console.log('Center region detection failed:', e);
            }
            
            // Method 3: Enhanced contrast detection
            try {
                const imageData = context.getImageData(0, 0, width, height);
                // Simple contrast enhancement
                const data = imageData.data;
                for (let i = 0; i < data.length; i += 4) {
                    const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                    const enhanced = avg > 128 ? 255 : 0; // High contrast black/white
                    data[i] = data[i + 1] = data[i + 2] = enhanced;
                }
                
                const result = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert"
                });
                if (result && result.data) return result;
            } catch (e) {
                console.log('Enhanced contrast detection failed:', e);
            }
            
            return null;
        }
        
        // Handle QR code detection with validation
        function handleQRDetection(qrData) {
            // Check if this is the same QR as last detection
            if (detectionState.lastDetected === qrData) {
                detectionState.consecutiveDetections++;
                
                // Show progress
                updateStatus(
                    `üì± QR code confirmed ${detectionState.consecutiveDetections}/${detectionState.requiredDetections}`, 
                    'scanning'
                );
                
                // Process when we have enough confirmations
                if (detectionState.consecutiveDetections >= detectionState.requiredDetections) {
                    processConfirmedQR(qrData);
                }
            } else {
                // New QR detected
                detectionState.lastDetected = qrData;
                detectionState.consecutiveDetections = 1;
                updateStatus('üì± New QR detected, confirming...', 'scanning');
                console.log('New QR detected:', qrData.substring(0, 100) + '...');
            }
        }
        
        // Process confirmed QR code
        function processConfirmedQR(qrData) {
            detectionState.processingQR = true;
            updateStatus('üîç Processing QR code...', 'info');
            
            console.log('Processing confirmed QR:', qrData);
            
            // Reset detection state
            detectionState.lastDetected = null;
            detectionState.consecutiveDetections = 0;
            
            try {
                // Try to parse as new format (JSON with email and data)
                const parsedData = JSON.parse(qrData);
                if (parsedData.email && parsedData.data) {
                    console.log('New format QR detected:', parsedData.email);
                    updateStatus(`üìß Processing coupon for ${parsedData.email}`, 'info');
                    verifyCoupon(parsedData.data, parsedData.email);
                    return;
                }
            } catch (e) {
                console.log('Not JSON format, treating as legacy QR');
            }
            
            // Handle legacy format (just encrypted data)
            const manualEmail = document.getElementById('manualEmail').value.trim();
            if (manualEmail) {
                console.log('Using manual email for legacy QR:', manualEmail);
                updateStatus(`üîç Processing with email: ${manualEmail}`, 'info');
                verifyCoupon(qrData, manualEmail);
            } else {
                // Need email for legacy format
                updateStatus('üìß Email required for this QR code', 'warning');
                showResult(`
                    <div style="background: rgba(255, 193, 7, 0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(255, 193, 7, 0.3);">
                        <h3 style="color: #f59e0b; margin-bottom: 15px;">‚ö†Ô∏è Email Required</h3>
                        <p><strong>This QR code requires an email address.</strong></p>
                        <p>Please enter the recipient's email in the "Manual Verification" section below, then try scanning again.</p>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button onclick="resumeScanning()" class="btn btn-primary" style="margin-right: 10px;">
                                üîÑ Resume Scanning
                            </button>
                            <button onclick="document.querySelector('#manualEmail').focus(); document.querySelector('.manual-entry').scrollIntoView({behavior: 'smooth'})" class="btn btn-secondary">
                                üìù Enter Email Below
                            </button>
                        </div>
                    </div>
                `, 'warning');
                
                // Auto-resume scanning after 8 seconds
                setTimeout(resumeScanning, 8000);
            }
        }
        
        // Resume scanning after processing - fixed to work reliably
        function resumeScanning() {
            console.log('üîÑ Resuming scanning...');
            
            // Reset all detection state
            resetDetectionState();
            
            // Ensure video is still available and playing
            if (video && video.srcObject && !video.paused) {
                scanning = true;
                updateStatus('üì± Scanning for QR codes...', 'scanning');
                
                // Clear any existing result
                document.getElementById('resultSection').style.display = 'none';
                
                // Restart the scanning loop
                requestAnimationFrame(scanQRCode);
                
                console.log('‚úÖ Scanning resumed successfully');
            } else {
                console.log('‚ö†Ô∏è Video not available, restarting scanner...');
                // If video is not available, restart the entire scanner
                stopScanner();
                setTimeout(() => {
                    document.getElementById('startBtn').click();
                }, 500);
            }
        }
        
        // Coupon verification with immediate scanning resume
        async function verifyCoupon(encryptedData, email = null) {
            try {
                updateStatus('üîç Verifying coupon...', 'info');
                
                const response = await fetch('/verify-coupon', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        encrypted_data: encryptedData,
                        email: email
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    updateStatus('‚úÖ Coupon verified successfully!', 'success');
                    
                    // Show success popup briefly
                    showVerificationModal({
                        success: true,
                        title: 'üéâ Verification Successful!',
                        message: 'Attendee admitted to event',
                        details: {
                            'Coupon ID': result.coupon_id,
                            'Email': result.email,
                            'Event': result.event_name,
                            'Verified': new Date().toLocaleString()
                        },
                        autoClose: true
                    });
                    
                    // Show brief success message in scanner area
                    showResult(`
                        <div style="background: rgba(16, 185, 129, 0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(16, 185, 129, 0.3); text-align: center;">
                            <h3 style="color: var(--success); margin-bottom: 10px;">‚úÖ VERIFIED</h3>
                            <p style="margin: 5px 0;"><strong>${result.email}</strong></p>
                            <p style="margin: 5px 0; font-size: 14px; color: var(--text-secondary);">${result.event_name}</p>
                            <p style="margin: 10px 0; font-size: 12px; color: var(--text-muted);">
                                Thank you email: ${result.thank_you_email === 'sent' ? '‚úÖ Sent' : '‚ö†Ô∏è Pending'}
                            </p>
                        </div>
                    `, 'success');
                    
                    // Resume scanning after short delay
                    setTimeout(() => {
                        closeVerificationModal();
                        resumeScanning();
                    }, 2000);
                    
                } else {
                    updateStatus('‚ùå Coupon verification failed', 'error');
                    
                    let errorTitle = '‚ùå Verification Failed';
                    let errorMessage = '';
                    
                    switch (result.error_code) {
                        case 'ALREADY_USED':
                            errorTitle = '‚ö†Ô∏è Already Used';
                            errorMessage = 'This coupon has already been redeemed.';
                            if (result.used_at) {
                                errorMessage += `<br><small>Used: ${new Date(result.used_at).toLocaleString()}</small>`;
                            }
                            break;
                        case 'EXPIRED':
                            errorTitle = '‚è∞ Expired';
                            errorMessage = 'This coupon has expired.';
                            break;
                        case 'NOT_FOUND':
                            errorTitle = 'üîç Not Found';
                            errorMessage = 'Coupon not found in database.';
                            break;
                        case 'DECRYPTION_FAILED':
                            errorTitle = 'üîí Invalid Format';
                            errorMessage = 'Invalid or corrupted coupon data.';
                            break;
                        default:
                            errorMessage = result.error;
                    }
                    
                    // Show error briefly
                    showResult(`
                        <div style="background: rgba(239, 68, 68, 0.1); padding: 15px; border-radius: 12px; border: 1px solid rgba(239, 68, 68, 0.3); text-align: center;">
                            <h3 style="color: var(--error); margin-bottom: 10px;">${errorTitle}</h3>
                            <p style="color: var(--text-secondary);">${errorMessage}</p>
                        </div>
                    `, 'error');
                    
                    // Resume scanning after brief pause
                    setTimeout(() => {
                        resumeScanning();
                    }, 1500);
                }
                
            } catch (error) {
                console.error('Error verifying coupon:', error);
                updateStatus('‚ùå Network error', 'error');
                
                showResult(`
                    <div style="background: rgba(239, 68, 68, 0.1); padding: 15px; border-radius: 12px; border: 1px solid rgba(239, 68, 68, 0.3); text-align: center;">
                        <h3 style="color: var(--error); margin-bottom: 10px;">üåê Network Error</h3>
                        <p style="color: var(--text-secondary);">Could not connect to server. Check connection.</p>
                    </div>
                `, 'error');
                
                // Resume scanning after brief pause
                setTimeout(() => {
                    resumeScanning();
                }, 1500);
            }
        }
        
        // Show verification result modal with auto-close option
        function showVerificationModal(result) {
            const modal = document.getElementById('verificationModal');
            const content = document.getElementById('verificationContent');
            
            if (result.success) {
                content.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 72px; margin-bottom: 20px; animation: bounce 0.6s ease-in-out;">üéâ</div>
                        <h2 style="color: var(--success); margin-bottom: 15px; font-size: 28px;">${result.title}</h2>
                        <p style="color: var(--text-secondary); font-size: 18px; margin-bottom: 30px;">${result.message}</p>
                        
                        <div style="background: rgba(16, 185, 129, 0.1); padding: 25px; border-radius: 12px; border: 1px solid rgba(16, 185, 129, 0.3); text-align: left;">
                            ${Object.entries(result.details).map(([key, value]) => 
                                `<div style="display: flex; justify-content: space-between; margin-bottom: 10px; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                    <strong style="color: var(--text-primary);">${key}:</strong>
                                    <span style="color: var(--text-secondary); text-align: right; max-width: 60%;">${value}</span>
                                </div>`
                            ).join('')}
                        </div>
                        
                        ${result.autoClose ? '<p style="margin-top: 20px; color: var(--text-muted); font-size: 14px;">Auto-resuming scan in 2 seconds...</p>' : ''}
                    </div>
                `;
                
                // Auto-close if specified
                if (result.autoClose) {
                    setTimeout(() => {
                        closeVerificationModal();
                    }, 2000);
                }
            } else {
                content.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 72px; margin-bottom: 20px; animation: shake 0.6s ease-in-out;">‚ùå</div>
                        <h2 style="color: var(--error); margin-bottom: 15px; font-size: 28px;">${result.title}</h2>
                        <p style="color: var(--text-secondary); font-size: 18px; margin-bottom: 30px;">${result.message}</p>
                    </div>
                `;
            }
            
            modal.style.display = 'block';
            
            // Add keyboard listener for Enter/Esc
            document.addEventListener('keydown', handleVerificationModalKeys);
        }
        
        // Close verification modal
        function closeVerificationModal() {
            const modal = document.getElementById('verificationModal');
            modal.style.display = 'none';
            
            // Remove keyboard listener
            document.removeEventListener('keydown', handleVerificationModalKeys);
        }
        
        // Handle keyboard shortcuts in verification modal
        function handleVerificationModalKeys(event) {
            if (event.key === 'Enter' || event.key === 'Escape') {
                closeVerificationModal();
                if (event.key === 'Enter') {
                    resumeScanning();
                }
            }
        }
        
        // Manual verification
        async function verifyManual() {
            const email = document.getElementById('manualEmail').value.trim();
            const manualData = document.getElementById('manualData').value.trim();
            
            if (!manualData) {
                showResult('‚ùå Please enter the coupon data.', 'error');
                return;
            }
            
            try {
                const couponInfo = JSON.parse(manualData);
                if (couponInfo.email && couponInfo.data) {
                    showResult(`üìß Email automatically extracted: ${couponInfo.email}`, 'info');
                    await verifyCoupon(couponInfo.data, couponInfo.email);
                    return;
                }
            } catch (e) {
                // Not JSON, continue with old format
            }
            
            if (!email) {
                showResult('‚ùå Please enter both email address and encrypted coupon data.', 'error');
                return;
            }
            
            await verifyCoupon(manualData, email);
        }
        
        // Enhanced camera help function with mobile-specific guidance
        function showCameraHelp() {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isAndroid = /Android/i.test(navigator.userAgent);
            
            let helpContent = `
                <div style="background: rgba(99, 102, 241, 0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(99, 102, 241, 0.3); margin: 20px 0;">
                    <h3 style="color: var(--accent-primary); margin-bottom: 15px;">üì± Camera Permission Help</h3>
                    
                    <div style="text-align: left; margin: 15px 0;">
            `;
            
            if (isIOS) {
                helpContent += `
                    <strong>üçé For iPhone/iPad (Safari):</strong><br>
                    1. When camera permission popup appears, tap "Allow"<br>
                    2. If no popup appears:<br>
                    &nbsp;&nbsp;&nbsp;‚Ä¢ Settings > Safari > Camera > "Allow"<br>
                    &nbsp;&nbsp;&nbsp;‚Ä¢ Settings > Privacy & Security > Camera > Safari > "Allow"<br>
                    3. Return to this page and refresh<br><br>
                    
                    <strong>üçé For iPhone/iPad (Chrome):</strong><br>
                    1. Tap the "aA" icon in the address bar<br>
                    2. Select "Website Settings"<br>
                    3. Tap "Camera" and select "Allow"<br>
                    4. Refresh the page<br><br>
                `;
            } else if (isAndroid) {
                helpContent += `
                    <strong>ü§ñ For Android (Chrome):</strong><br>
                    1. Look for camera icon (üì∑) in the address bar<br>
                    2. Tap it and select "Allow"<br>
                    3. If no icon: Tap the 3 dots menu > Settings > Site settings > Camera > Allow<br>
                    4. Refresh this page<br><br>
                    
                    <strong>ü§ñ For Android (Firefox):</strong><br>
                    1. Tap the shield or lock icon in address bar<br>
                    2. Tap "Permissions" and enable camera<br>
                    3. Refresh the page<br><br>
                `;
            } else if (isMobile) {
                helpContent += `
                    <strong>üì± For Mobile Browsers:</strong><br>
                    1. Look for camera or permission icons in the address bar<br>
                    2. Tap and allow camera access<br>
                    3. Refresh this page<br><br>
                `;
            }
            
            helpContent += `
                        <strong>üõ°Ô∏è For Brave Browser:</strong><br>
                        1. Look for the shield icon (üõ°Ô∏è) in the address bar<br>
                        2. Tap it and toggle "Camera" to ON<br>
                        3. Refresh this page<br><br>
                        
                        <strong>üîß If still not working:</strong><br>
                        1. Clear browser cache and cookies<br>
                        2. Try using Chrome or Safari browsers<br>
                        3. Make sure you're using HTTPS (secure connection)<br>
                        4. Restart your browser completely<br>
                        5. Check if camera works in your device's camera app<br>
                        6. Try manual verification below as backup<br><br>
                        
                        <strong>‚ö†Ô∏è Common Issues:</strong><br>
                        ‚Ä¢ Another app is using the camera<br>
                        ‚Ä¢ Browser is outdated<br>
                        ‚Ä¢ Device's camera privacy settings are too restrictive<br>
                        ‚Ä¢ Using HTTP instead of HTTPS<br>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="location.reload()" class="btn btn-primary" style="margin-right: 10px;">
                            üîÑ Refresh & Try Again
                        </button>
                        <button onclick="document.querySelector('.manual-entry').scrollIntoView({behavior: 'smooth'})" class="btn btn-secondary">
                            üìù Use Manual Entry
                        </button>
                    </div>
                </div>
            `;
            
            showResult(helpContent, 'info');
        }
        
        // Device registration functions
        function showDeviceRegistration() {
            const isPrivateIP = window.location.hostname.match(/^(192\.168\.|10\.|172\.(1[6-9]|2[0-9]|3[01])\.|127\.0\.0\.1)/);
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isPrivateIP || isMobile) {
                document.getElementById('deviceRegistrationModal').style.display = 'block';
                
                const deviceNameInput = document.getElementById('deviceName');
                if (isMobile) {
                    deviceNameInput.value = `Mobile-Scanner-${Math.random().toString(36).substr(2, 4)}`;
                } else {
                    deviceNameInput.value = `Scanner-${Math.random().toString(36).substr(2, 4)}`;
                }
            }
        }
        
        function registerDevice() {
            const staffEmail = document.getElementById('staffEmail').value.trim();
            const deviceName = document.getElementById('deviceName').value.trim();
            const eventName = document.getElementById('eventName').value.trim();
            
            if (!staffEmail || !deviceName || !eventName) {
                alert('Please fill in all fields to register your device.');
                return;
            }
            
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(staffEmail)) {
                alert('Please enter a valid email address.');
                return;
            }
            
            deviceInfo = {
                staff_email: staffEmail,
                device_name: deviceName,
                event_name: eventName
            };
            
            deviceRegistered = true;
            document.getElementById('deviceRegistrationModal').style.display = 'none';
            
            showResult(`‚úÖ Device registered successfully!<br><br>
                <strong>Staff:</strong> ${staffEmail}<br>
                <strong>Device:</strong> ${deviceName}<br>
                <strong>Event:</strong> ${eventName}<br><br>
                You can now use all scanner features with real-time synchronization.`, 'success');
        }
        
        function skipRegistration() {
            document.getElementById('deviceRegistrationModal').style.display = 'none';
            showResult(`‚ö†Ô∏è Device registration skipped.<br><br>
                You can still scan tickets, but real-time synchronization with other devices will not be available.<br><br>
                To enable full features, refresh the page and complete registration.`, 'warning');
        }
        
        // Enhanced mobile initialization with keyboard shortcuts
        window.addEventListener('load', function() {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
            
            // Check for HTTPS on mobile
            if (isMobile && !isSecure) {
                showResult(`
                    <div style="background: rgba(239, 68, 68, 0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(239, 68, 68, 0.3);">
                        <h3 style="color: #ef4444; margin-bottom: 15px;">üîí HTTPS Required</h3>
                        <p>Camera access on mobile devices requires a secure (HTTPS) connection.</p>
                        <p style="margin-top: 15px;"><strong>Please use the HTTPS version of this site to enable camera scanning.</strong></p>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button onclick="window.location.href = window.location.href.replace('http:', 'https:')" class="btn btn-primary" style="margin-right: 10px;">
                                üîí Switch to HTTPS
                            </button>
                            <button onclick="document.querySelector('.manual-entry').scrollIntoView({behavior: 'smooth'})" class="btn btn-secondary">
                                üìù Use Manual Entry
                            </button>
                        </div>
                    </div>
                `, 'error');
                return;
            }
            
            // Add keyboard shortcuts
            document.addEventListener('keydown', function(event) {
                // Spacebar for capture (when camera is active)
                if (event.code === 'Space' && !document.getElementById('captureBtn').disabled) {
                    event.preventDefault();
                    captureAndScan();
                }
                
                // Enter key for manual verification
                if (event.code === 'Enter' && (
                    document.activeElement === document.getElementById('manualData') ||
                    document.activeElement === document.getElementById('manualEmail')
                )) {
                    event.preventDefault();
                    verifyManual();
                }
            });
            
            // Show device registration after a delay
            setTimeout(showDeviceRegistration, 1000);
        });
        
        // Add mobile-friendly touch events for capture
        let touchStartTime = 0;
        
        document.addEventListener('touchstart', function(event) {
            // Long press on video area for capture
            if (event.target.id === 'video' && !document.getElementById('captureBtn').disabled) {
                touchStartTime = Date.now();
            }
        });
        
        document.addEventListener('touchend', function(event) {
            if (event.target.id === 'video' && !document.getElementById('captureBtn').disabled) {
                const touchDuration = Date.now() - touchStartTime;
                
                // If long press (>500ms), trigger capture
                if (touchDuration > 500) {
                    event.preventDefault();
                    captureAndScan();
                    
                    // Show feedback
                    updateStatus('üì∏ Long press detected - Capturing...', 'info');
                }
            }
            touchStartTime = 0;
        });
        
        // Enhanced camera support check
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            updateStatus('Camera not supported on this device', 'error');
            document.getElementById('startBtn').disabled = true;
            
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const supportMessage = isMobile ? 
                'Camera access is not supported on this browser. Please try Chrome, Safari, or Firefox.' :
                'Camera access is not supported on this device.';
                
            showResult(`‚ùå ${supportMessage} Please use the manual verification option below.`, 'error');
        }
        
        // Cleanup on page close
        window.addEventListener('beforeunload', function() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>